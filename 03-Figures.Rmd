---
title: "Figures"
author: "Nils Eling and Nicolas Damond"
date: "2020-06-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script reproduces the analysis performed in the `cytomapper` publication and generates all displayed figures.
The analysis was performed using cytomapper version 1.0.0, Biocondcutor version 3.11 and R version 4.0.

Please follow the pre-processing scripts in the `Preprocessing` folder to download the data and generate the following objects:

1. A `SingleCellExperiment` object containing the cell- and marker-specific expression and metadata.
2. A `CytoImageList` object containing 100 example images, where each image contains 38 channels
3. A `CytoImageList` object containing 100 example masks, which are associated to and a segmentation result of the images in 2.

Here, we will load all relevant libraries and read in the data.

```{r read-in-data, message=FALSE}
library(dplyr)
library(SingleCellExperiment)
library(cytomapper)

sce <- readRDS(file.path("Preprocessing", "PancreasData", "pancreas_sce.rds"))
images <- readRDS(file.path("Preprocessing", "PancreasData", "pancreas_images.rds"))
masks <- readRDS(file.path("Preprocessing", "PancreasData", "pancreas_masks.rds"))
```

# Figure 3

In type 1 diabetes (T1D), pancreatic insulin-producing beta cells are killed by self-reacting immune cells. Here, we will visualize association between T cells and beta cells in three pancreas donors at different stage of the disease (Non-diabetic, recent onset T1D and long duration T1D).  

In our dataset, cell types can be visualized in the `CellType` column of `colData(sce)` (`unique(colData(sce)$CellType)`). T cells have the cell type `Tc` (CD8+) or `Th` (CD4+) and beta cells are labelled as `beta`.  

First, we will select for each donor the image with the highest density of T cells (number of T cells per mm^2). Then, we will subset the `SingleCellExperiment` object (`sce`) and the `CytoImageList` objects (`images` and `masks`).

```{r select-images}
# Select the three images with the higest T cell density
selected.images <- as_tibble(colData(sce)) %>% 
  # Calculate for each image the area, number of T cells and T cell density
  group_by(ImageNumber) %>%
  mutate(ImageArea = (width * height) / 10^6,
         TcellCount = sum(CellType == "Tc" | CellType == "Th"),
         TcellDensity = TcellCount / ImageArea) %>%
  ungroup() %>%
  # Select for each disease stage the image with the highest T cell density
  group_by(stage) %>%
  dplyr::slice(which.max(TcellDensity)) %>%
  pull(ImageName)

print(selected.images)

# Subset the objects
cur.sce <- sce[, sce$ImageName %in% selected.images]
cur.images <- images[mcols(images)$ImageName %in% selected.images]
cur.masks <- masks[mcols(masks)$ImageName %in% selected.images]
```

## Plot cells

To visualize association between islet and T cells, we will use the `plotCells` function and display beta and T cells on the three images selected above.  

The different cell types will be coloured as following: Tc cells in red, Th cells in blue, beta cells in yellow, the other islet cells (alpha, gamma, delta) in cyan and the rest of the cells in black.

```{r plotCells}
# Define the colors for the different cell types
ct.colours <- rep("black", length(unique(sce$CellType)))
names(ct.colours) <- unique(sce$CellType)
ct.colours["beta"] <- "yellow"
ct.colours[c("alpha", "gamma", "delta")] <- "cyan"
ct.colours["Tc"] <- "red"
ct.colours["Th"] <- "blue"

# Plot the cells
plotCells(mask = cur.masks,
          object = cur.sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellType",
          colour = list(CellType = ct.colours),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             cex = 1.1),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m")))
```

We now see that T cells are located closer to the islet on the "Recent onset T1D" image. In addition, no beta cells are visible on the "Long duration T1D" image, as expected because they have been destroyed by the immune system.    

We will now confirm that this is reflected on the original images by plotting the corresponding pixel-level data with the `plotPixels` function. CD4 (`CD4` expressed by Th cells) will be plotted in blue, CD8 (`CD8a`, Tc cells) in red and proinsulin (`PIN`, beta cells) in yellow.

```{r plotPixels}
plotPixels(object = cur.sce,
           image = cur.images,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         # SYP = c("black", "cyan"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 4, 1),
                      # SYP = c(0, 3, 1),
                      CD4 = c(0, 3, 1),
                      CD8a = c(0, 3, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D"),
                              cex = 1.1),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")))
```

This plot confirms that beta cells are surrounded by infiltrating T cells on the "Recent onset T1D" image. In addition, proinsulin abundance seems to be reduced on that image as compared to the "Non-diabetic" control image. This observation can be further explored by performing additional data analysis.



## Alternative

Plot only islet and immune cell types first.

```{r plotCells2}
# Define the colors for the different cell types
cat.colours <- rep("black", length(unique(sce$CellCat)))
names(cat.colours) <- unique(sce$CellCat)
cat.colours["islet"] <- "yellow"
cat.colours["immune"] <- "red"

# Plot the cells
plotCells(mask = cur.masks,
          object = cur.sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellCat",
          colour = list(CellCat = cat.colours),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             cex = 1.1),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m")))
```


Then plot the channels corresponding to the different immune cell types (and we see that we have mostly T cells around the islet on the "Recent onset T1D" image).

```{r plotPixels2}
plotPixels(object = cur.sce,
           image = cur.images,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a", "CD20", "CD68", "MPO"), 
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "cyan"),
                         CD8a = c("black", "red"),
                         CD20 = c("black", "white"),
                         CD68 = c("black", "blue"),
                         MPO = c("black", "magenta")),
           bcg = list(PIN = c(0, 4, 1.2),
                      CD4 = c(0, 4, 1),
                      CD8a = c(0, 5, 1.2),
                      CD20 = c(0, 5, 1.2),
                      CD68 = c(0, 5, 1.2),
                      MPO = c(0, 5, 1.2)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D"),
                              cex = 1.1),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")))
```

```{r}
sessionInfo()
```
