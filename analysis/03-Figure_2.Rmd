---
title: "Figure 2"
author: "Nils Eling and Nicolas Damond"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script reproduces the analysis performed in Figure 2.
Here, we will load the libraries required for data analysis:

```{r load-libraries, message=FALSE}
library(dplyr)
library(SingleCellExperiment)
library(cytomapper)
```

The previous scripts have generated the following files in the `data/PancreasData` folder:

1. A `SingleCellExperiment` object containing the cell- and marker-specific expression and metadata.
2. A `CytoImageList` object containing 100 example images of 3 donors, where each image contains 38 channels
3. A `CytoImageList` object containing 100 example masks, which are associated to and a segmentation result of the images in 2.

Here, we will load all relevant libraries and read in the data.

```{r read-in-data, message=FALSE}
sce <- readRDS("data/PancreasData/pancreas_sce.rds")
images <- readRDS("data/PancreasData/pancreas_images.rds")
masks <- readRDS("data/PancreasData/pancreas_masks.rds")
```

In type 1 diabetes (T1D), pancreatic insulin-producing beta cells are killed by self-reacting immune cells. 
Here, we will visualize association between T cells and beta cells in three pancreas donors at different stage of the disease (Non-diabetic, recent onset T1D and long duration T1D).  

In our dataset, cell types can be visualized in the `CellType` column of `colData(sce)` (`unique(colData(sce)$CellType)`). 
T cells have the cell type `Tc` (CD8+) or `Th` (CD4+) and beta cells are labelled as `beta`.  

First, we will select for each donor the image with the highest density of T cells (number of T cells per mm^2). 
Then, we will subset the `SingleCellExperiment` object (`sce`) and the `CytoImageList` objects (`images` and `masks`).

```{r select-images}
# Select the three images with the higest T cell density
selected.images <- as_tibble(colData(sce)) %>% 
  # Calculate for each image the area, number of T cells and T cell density
  group_by(ImageNumber) %>%
  mutate(ImageArea = (width * height) / 10^6,
         TcellCount = sum(CellType == "Tc" | CellType == "Th"),
         TcellDensity = TcellCount / ImageArea) %>%
  ungroup() %>%
  # Select for each disease stage the image with the highest T cell density
  group_by(stage) %>%
  dplyr::slice(which.max(TcellDensity)) %>%
  pull(ImageName)

print(selected.images)

# Subset the objects
cur_sce <- sce[, sce$ImageName %in% selected.images]
cur_images <- images[mcols(images)$ImageName %in% selected.images]
cur_masks <- masks[mcols(masks)$ImageName %in% selected.images]
```

## Plot cells

To visualize association between islet and T cells, we will use the `plotCells` function and display beta and T cells on the three images selected above.  

The different cell types will be coloured as following: Tc cells in red, Th cells in blue, beta cells in yellow, the other islet cells (alpha, delta) in cyan and the rest of the cells in black.

To display only a selected number of cells, the `SingleCellExperiment` can be subsetted.

```{r plotCells}
cur_sce <- cur_sce[,cur_sce$CellType %in% c("beta", "alpha", "delta", "Tc", "Th")]

# Define the colors for the different cell types
ct_colours <- vector(mode = "character", length = length(unique(cur_sce$CellType)))
names(ct_colours) <- unique(cur_sce$CellType)
ct_colours["beta"] <- "yellow"
ct_colours[c("alpha", "delta")] <- "cyan"
ct_colours["Tc"] <- "red"
ct_colours["Th"] <- "blue"

# Plot the cells
plotCells(mask = cur_masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellType",
          colour = list(CellType = ct_colours),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray")

# Save figure
plotCells(mask = cur_masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          colour_by = "CellType",
          colour = list(CellType = ct_colours),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray", 
          save_plot = list(filename = "docs/final_figures/main/Fig_2A.png", scale = 3))
```

We now see that T cells are located closer to the islet on the "Recent onset T1D" image. 
In addition, no beta cells are visible on the "Long duration T1D" image, as expected because they have been destroyed by the immune system.    

We will now confirm that this is reflected on the original images by (i) plotting the corresponding expression values on the mask using the `plotCells` function and (ii) plotting the pixel-level data with the `plotPixels` function. 
CD4 (`CD4` expressed by Th cells) will be plotted in blue, CD8 (`CD8a`, Tc cells) in red and proinsulin (`PIN`, beta cells) in yellow.

First, we will plot the arcsinh-transformed averaged expression on the images.

```{r plotCells-meanExpression}
plotCells(mask = cur_masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          exprs_values = "exprs",
          colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray")

# Save figure
plotCells(mask = cur_masks,
          object = cur_sce,
          cell_id = "CellNumber",
          img_id = "ImageName",
          exprs_values = "exprs",
          colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
          image_title = list(text = c("Non-diabetic",
                                      "Recent onset T1D",
                                      "Long duration T1D"),
                             colour = "black"),
          scale_bar = list(length = 100,
                           label = expression("100 " ~ mu * "m"),
                           colour = "black"),
          missing_colour = "white",
          background_colour = "gray",
           save_plot = list(filename = "docs/final_figures/main/Fig_2B.png", scale = 3))
```

Finally, we will display the pixel-level information on the images.

```{r plotPixels}
plotPixels(image = cur_images,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         # SYP = c("black", "cyan"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 4, 1),
                      # SYP = c(0, 3, 1),
                      CD4 = c(0, 3, 1),
                      CD8a = c(0, 3, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")))

# Save figure
plotPixels(image = cur_images,
           cell_id = "CellNumber",
           img_id = "ImageName",
           colour_by = c("PIN", "CD4", "CD8a"), 
           colour = list(PIN = c("black", "yellow"),
                         # SYP = c("black", "cyan"),
                         CD4 = c("black", "blue"),
                         CD8a = c("black", "red")),
           bcg = list(PIN = c(0, 4, 1),
                      # SYP = c(0, 3, 1),
                      CD4 = c(0, 3, 1),
                      CD8a = c(0, 3, 1)),
           image_title = list(text = c("Non-diabetic",
                                       "Recent onset T1D",
                                       "Long duration T1D")),
           scale_bar = list(length = 100,
                            label = expression("100 " ~ mu * "m")),
           save_plot = list(filename = "docs/final_figures/main/Fig_2C.png", scale = 3))
```

This plot confirms that beta cells are surrounded by infiltrating T cells on the "Recent onset T1D" image. 
In addition, proinsulin abundance seems to be reduced on that image as compared to the "Non-diabetic" control image. 
This observation can be further explored by performing additional data analysis.

## Figure 3
