---
title: "Subsetting to form toy dataset"
author: "Nils Eling"
editor_options:
  chunk_output_type: inline
---

In this script, we will subset images and the SingleCellExperiment object to only contain a small number of cells and a small number of channels.

# Read in data

```{r load-data}
library(SingleCellExperiment)
library(cytomapper)
sce <- readRDS("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/sce.rds")
```

# Read in Images

Next, we will read in the images for subsetting.

```{r read-images}
A02_tiff <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/A02_imc.tiff")
D01_tiff <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/D01_imc.tiff")
F01_tiff <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/F01_imc.tiff")

A02_mask <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/A02_mask.tiff", as.is=TRUE)
D01_mask <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/D01_mask.tiff", as.is=TRUE)
F01_mask <- readImage("~/switchdrive/Institution/SingleCellMapper/Data/raw_data/images/F01_mask.tiff", as.is=TRUE)
```

# Subsetting the images

For convenience, we will subset the images to 50 time 50 pixels and 5 channels.

```{r image-subsetting}
x_dim <- 100
y_dim <- 100
z_dim <- 5
A02_tiff_subsetted <- A02_tiff[1:x_dim,1:y_dim,1:z_dim]
D01_tiff_subsetted <- D01_tiff[1:x_dim,1:y_dim,1:z_dim]
F01_tiff_subsetted <- F01_tiff[1:x_dim,1:y_dim,1:z_dim]

A02_mask_subsetted <- A02_mask[1:x_dim,1:y_dim]
D01_mask_subsetted <- D01_mask[1:x_dim,1:y_dim]
F01_mask_subsetted <- F01_mask[1:x_dim,1:y_dim]
```

# Subsetting the SingleCellExperiment object

We now have to match the SingleCellExperiment object to the selected cells.

```{r subsetting-sce}
A02_cells <- names(table(A02_mask_subsetted))[-1]
D01_cells <- names(table(D01_mask_subsetted))[-1]
F01_cells <- names(table(F01_mask_subsetted))[-1]
sce_subsetted <- cbind(sce[,sce$ImageNb == 1 & sce$CellNb %in% A02_cells],
                       sce[,sce$ImageNb == 2 & sce$CellNb %in% D01_cells],
                       sce[,sce$ImageNb == 3 & sce$CellNb %in% F01_cells])

pancreasSCE <- sce_subsetted[1:5,]
set.seed(12345)
pancreasSCE$CellType <- sample(c("celltype_A", "celltype_B", "celltype_C"), 
                               ncol(pancreasSCE), replace = TRUE)
pancreasSCE$Pattern <- pancreasSCE$Pos_X < 50
```

# Save Objects for package

The EBImage and tiff package does not support 32-bit encodings for images.
However, after compensation, the pixels contain floats rather than integers.
We have to use the ijtiff package to write out the images.
*Of Note:* The file names need to be changed to '.tiff' after saving since the ijtiff package has this weird way of saving every image as '.tif'.

```{r save-objects, message=FALSE}
library(ijtiff)
write_tif(imageData(transpose(A02_tiff_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/A02_imc.tiff",
          bits_per_sample = 32L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/A02_imc.tif /Users/nils/Github/cytomapper/inst/extdata/A02_imc.tiff")
write_tif(imageData(transpose(D01_tiff_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/D01_imc.tiff",
          bits_per_sample = 32L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/D01_imc.tif /Users/nils/Github/cytomapper/inst/extdata/D01_imc.tiff")
write_tif(imageData(transpose(F01_tiff_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/F01_imc.tiff",
          bits_per_sample = 32L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/F01_imc.tif /Users/nils/Github/cytomapper/inst/extdata/F01_imc.tiff")

write_tif(imageData(transpose(A02_mask_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/A02_mask.tiff",
          bits_per_sample = 16L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/A02_mask.tif /Users/nils/Github/cytomapper/inst/extdata/A02_mask.tiff")
write_tif(imageData(transpose(D01_mask_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/D01_mask.tiff",
          bits_per_sample = 16L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/D01_mask.tif /Users/nils/Github/cytomapper/inst/extdata/D01_mask.tiff")
write_tif(imageData(transpose(F01_mask_subsetted)), 
          path = "/Users/nils/Github/cytomapper/inst/extdata/F01_mask.tiff",
          bits_per_sample = 16L, overwrite = TRUE)
system("mv /Users/nils/Github/cytomapper/inst/extdata/F01_mask.tif /Users/nils/Github/cytomapper/inst/extdata/F01_mask.tiff")
```

# Create example image lists

```{r example-image-lists}
pancreasMasks <- CytoImageList(A02_mask = A02_mask_subsetted, 
                           D01_mask = D01_mask_subsetted, 
                           F01_mask = F01_mask_subsetted)
elementMetadata(pancreasMasks) <- DataFrame(ImageNb = 1:3)

pancreasImages <- CytoImageList(A02_imc = A02_tiff_subsetted, 
                            D01_imc = D01_tiff_subsetted, 
                            F01_imc = F01_tiff_subsetted)
channelNames(pancreasImages) <- rownames(pancreasSCE)
elementMetadata(pancreasImages) <- DataFrame(ImageNb = 1:3)
```

# Save SCE, mask IMCImageList and images IMCImageList

```{r}
save(pancreasSCE, file = "/Users/nils/Github/cytomapper/data/pancreasSCE.RData")
save(pancreasMasks, file = "/Users/nils/Github/cytomapper/data/pancreasMasks.RData")
save(pancreasImages, file = "/Users/nils/Github/cytomapper/data/pancreasImages.RData")
```
