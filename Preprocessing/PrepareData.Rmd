---
title: "Data import"
author: "Nicolas Damond"
editor_options:
  chunk_output_type: inline
---

# Goal
- Read in data exported from CellProfiler and store it as a SingleCellExperiment
For more information, see https://github.com/BodenmillerGroup/IMCWorkflow 

```{r load-packages, include=F}
library(SingleCellExperiment)
library(S4Vectors)
```

# Load the datasets
### Load CellProfiler output and panel file
- The Cells.csv and Image.csv files are measurements exported from CellProfiler
- The panel.csv has to be modified manually for each experiment according to the antibody panel that was used.
```{r read-in-data}
cells <- read.csv(file = "./cpoutput/Cells.csv", stringsAsFactors = FALSE)
image <- read.csv(file = "./cpoutput/Image.csv", stringsAsFactors = FALSE)
panel <- read.csv(file = "./panel.csv", stringsAsFactors = FALSE)
```

# Load cell-specific, image-specific and feature metadata
### List of cell features measured by CellProfiler
```{r cell-specific-metadata}
unique(sub("_c[0-9]*$", "", colnames(cells)))
```

### Load relevant cell-specific metadata
```{r cell-metadata}
cell.metadata <- DataFrame(ImageNb = cells$ImageNumber,
                           CellNb = cells$ObjectNumber,
                           Pos_X = cells$Location_Center_X,
                           Pos_Y = cells$Location_Center_Y,
                           Area = cells$AreaShape_Area,
                           MajorAxisLength = cells$AreaShape_MajorAxisLength,
                           MinorAxisLength = cells$AreaShape_MinorAxisLength)
```

### List of image features measured by CellProfiler
```{r image-specific-metadata}
colnames(image)
```

### Load relevant image-specific metadata
```{r image-metadata}
image.metadata <- DataFrame(ImageNb = image$ImageNumber,
                            ImageName = image$FileName_ImageStack,
                            MaskName = image$FileName_Mask,
                            ImagePath = image$PathName_ImageStack,
                            MaskPath = image$PathName_Mask,
                            ImageHeight = image$Height_ImageStack,
                            ImageWidth = image$Width_ImageStack)
```

### Merge cell and image metadata
```{r}
cell.metadata <- merge(cell.metadata, image.metadata, by="ImageNb")
```

### Add rownames
```{r cell-rownames}
rownames(cell.metadata) <- paste(sub(".tiff", "", cell.metadata$ImageName),
                                 cell.metadata$CellNb,
                                 sep = "_")
```

### Feature-specific metadata
Make sure that the frame number is the same in the image stack and in the dataset
```{r reorder-panel}
panel <- DataFrame(panel)
channel.mass <- read.csv("./images/A02_imc.csv", header = FALSE)
panel <- panel[match(channel.mass[,1], panel$MetalTag), ]
```

Add clean target names as rownames in the panel
```{r panel-rownames}
rownames(panel) <- panel$clean_Target
```


# Load single cell measurements
### Single cell intensity measurements
Here, we select the mean intensity
```{r select-counts}
counts <- cells[, grepl("Intensity_MeanIntensity_ImageStack", colnames(cells))]
```

### Scale counts
Count are sometimes scaled in CellProfiler
```{r scale-counts}
scale.factor <- image$Scaling_ImageStack[1]
counts <- counts * scale.factor
```

### Reorder the counts channels (based on channel number)
```{r reorder-counts}
channelNumber <- as.numeric(sub("^.*_c", "", colnames(counts)))
counts <- counts[, order(channelNumber, decreasing = FALSE)] 
```

# Create the SingleCellExperiment object
### Create SCE
```{r create-SCE}
sce <- SingleCellExperiment(assays = list(counts = t(counts)))
```

### Add transformed counts
exprs = asinh-transformed
log = log-transformed
```{r}
assay(sce, "exprs") <- asinh(counts(sce)/1)
assay(sce, "log") <- log(counts(sce))
```

### Set rownames
```{r create-SCE}
rownames(sce) <- rownames(panel)
colnames(sce) <- rownames(cell.metadata)
```

### Store metadata
```{r store-metadata}
colData(sce) <- cell.metadata
rowData(sce) <- panel
sce
```

### Save SCE
```{r save-SCE}
saveRDS(sce, "./sce.rds")
```



